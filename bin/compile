#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

BP_DIR="$(cd $(dirname $0)/..; pwd)" # absolute path
BIN_DIR="$BP_DIR/bin"

# parse args
BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

JVM_COMMON_BUILDPACK="${JVM_COMMON_BUILDPACK:-"https://codon-buildpacks.s3.amazonaws.com/buildpacks/heroku/jvm-common.tgz"}"
mkdir -p /tmp/jvm-common
curl --retry 3 --silent --location "$JVM_COMMON_BUILDPACK" | tar xzm -C /tmp/jvm-common --strip-components=1
. /tmp/jvm-common/bin/util
. /tmp/jvm-common/bin/java

install_java_with_overlay "${BUILD_DIR}"

VERSION_PROPERTIES="${BUILD_DIR}/system.properties"
if [ -f "${VERSION_PROPERTIES}" ]; then
  WILDFLY_VERSION="$(grep "^[^#]" "${VERSION_PROPERTIES}" | grep -E "wildfly\.version[[:blank:]]*=[[:blank:]]*[A-Za-z0-9\.]+$" | sed "s/^[^=]*=//")"
  echo "-----> Using WildFly version ${WILDFLY_VERSION}"
fi

WILDFLY_VERSION="${WILDFLY_VERSION:-16.0.0.Final}"
JBOSS_HOME="${BUILD_DIR}/.jboss/wildfly-${WILDFLY_VERSION}"

cd "$BUILD_DIR"

mkdir -p ".jboss"

echo "-----> Installing WildFly ${WILDFLY_VERSION} ..."
WILDFLY_DOWNLOAD_URL="https://download.jboss.org/wildfly/${WILDFLY_VERSION}/wildfly-${WILDFLY_VERSION}.zip"
curl --retry 3 -O "${WILDFLY_DOWNLOAD_URL}"
echo "-----> Downloaded"
WILDFLY_SHA1="$(curl --retry 3 "${WILDFLY_DOWNLOAD_URL}.sha1")"
sha1sum "wildfly-${WILDFLY_VERSION}.zip" | grep "${WILDFLY_SHA1}" > /dev/null 2>&1
echo "-----> Verified"
unzip -q "wildfly-${WILDFLY_VERSION}.zip"
echo "-----> Extracted"
mv "wildfly-${WILDFLY_VERSION}" "${JBOSS_HOME}"
echo "-----> Moved"
rm "wildfly-${WILDFLY_VERSION}.zip"
echo "-----> Installation of WildFly ${WILDFLY_VERSION} successful"

echo -n "-----> Deploying war file(s) ... "
cp target/*.war "${JBOSS_HOME}/standalone/deployments/"
echo "done"

echo "-----> Creating Process Configuration ..."
if [ -f "${BUILD_DIR}/Procfile" ]; then
  echo "        - Using existing process types in Procfile"
else
  cat << EOF > "${BUILD_DIR}/Procfile"
web: \$JBOSS_HOME/bin/standalone.sh -b 0.0.0.0 -Djboss.http.port=\$PORT
EOF
fi

cat << EOF > "${BUILD_DIR}/.profile.d/buildpack-wildfly-jboss.sh"
export JBOSS_HOME="${HOME}/.jboss/wildfly-${WILDFLY_VERSION}"
export WILDFLY_VERSION="${WILDFLY_VERSION}"
EOF
