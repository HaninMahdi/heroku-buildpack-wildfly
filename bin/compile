#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

BP_DIR="$(cd "${0%/*}/.."; pwd)" # absolute path
BIN_DIR="$BP_DIR/bin"

# parse args
BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

# see lib/wildfly_utils.sh
source "${BP_DIR}/lib/wildfly_utils.sh"

JVM_COMMON_BUILDPACK="${JVM_COMMON_BUILDPACK:-"https://codon-buildpacks.s3.amazonaws.com/buildpacks/heroku/jvm-common.tgz"}"
mkdir -p /tmp/jvm-common
curl --retry 3 --silent --location "$JVM_COMMON_BUILDPACK" | tar xzm -C /tmp/jvm-common --strip-components=1
source /tmp/jvm-common/bin/util
source /tmp/jvm-common/bin/java

install_java_with_overlay "${BUILD_DIR}"

VERSION_PROPERTIES="${BUILD_DIR}/system.properties"
use_wildfly_version "${VERSION_PROPERTIES}" WILDFLY_VERSION
if [ "${WILDFLY_VERSION+set}" == "set" ]; then
  status "Using WildFly version ${WILDFLY_VERSION}"
fi

WILDFLY_VERSION="${WILDFLY_VERSION:-16.0.0.Final}"
JBOSS_HOME="${BUILD_DIR}/.jboss/wildfly-${WILDFLY_VERSION}"

cd "$BUILD_DIR"

mkdir -p "${BUILD_DIR}/.jboss"

WILDFLY_ZIP="wildfly-${WILDFLY_VERSION}.zip"

status "Installing WildFly ${WILDFLY_VERSION} ..."
WILDFLY_DOWNLOAD_URL="https://download.jboss.org/wildfly/${WILDFLY_VERSION}/${WILDFLY_ZIP}"
curl --retry 3 -O "${WILDFLY_DOWNLOAD_URL}" 2>&1 | indent
status "Downloaded"
WILDFLY_SHA1="$(curl --retry 3 "${WILDFLY_DOWNLOAD_URL}.sha1")"
sha1sum "${WILDFLY_ZIP}" | grep "${WILDFLY_SHA1}" >/dev/null 2>&1
status "Verified"
unzip -d "${BUILD_DIR}/.jboss" -q "${WILDFLY_ZIP}"
status "Extracted"
rm "wildfly-${WILDFLY_VERSION}.zip"
status "Installation of WildFly ${WILDFLY_VERSION} successful"

status_pending "Deploying war file(s)"
cp target/*.war "${JBOSS_HOME}/standalone/deployments/"
status_done

status "Creating Process Configuration ..."
if [ -f "${BUILD_DIR}/Procfile" ]; then
  echo "        -> Using existing process types in Procfile"
else
  cat <<EOF >"${BUILD_DIR}/Procfile"
web: \$JBOSS_HOME/bin/standalone.sh -b 0.0.0.0 -Djboss.http.port=\$PORT
EOF
fi

cat <<EOF >"${BUILD_DIR}/.profile.d/buildpack-wildfly-jboss.sh"
export JBOSS_HOME="${HOME}/.jboss/wildfly-${WILDFLY_VERSION}"
export WILDFLY_VERSION="${WILDFLY_VERSION}"
EOF
